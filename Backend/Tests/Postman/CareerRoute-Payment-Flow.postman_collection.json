{
  "info": {
    "_postman_id": "careerroute-payment-flow",
    "name": "CareerRoute - Complete Payment Flow",
    "description": "Complete end-to-end payment flow including:\n1. Login\n2. Browse & Select Mentor\n3. Get Available Time Slots\n4. Book Session\n5. Create Payment Intent (Stripe/Paymob)\n6. Simulate Payment Webhook\n7. Confirm Payment\n8. Verify Session Confirmation\n9. Get Zoom Link\n\nThis flow tests the entire payment process from booking to session access.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. Login as Mentee",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Login successful', () => {",
              "    pm.response.to.have.status(200);",
              "    const data = pm.response.json().data;",
              "    pm.environment.set('token', data.token);",
              "    pm.environment.set('userId', data.user.id);",
              "    console.log('✓ Logged in as:', data.user.email);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"email\": \"{{menteeEmail}}\",\n    \"password\": \"{{menteePassword}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "login"]
        }
      }
    },
    {
      "name": "2. Get All Mentors",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Mentors retrieved', () => {",
              "    pm.response.to.have.status(200);",
              "    const mentors = pm.response.json().data;",
              "    pm.expect(mentors).to.be.an('array').with.length.above(0);",
              "    pm.environment.set('mentorId', mentors[0].id);",
              "    console.log('✓ Selected Mentor:', mentors[0].firstName, mentors[0].lastName);",
              "    console.log('  Mentor ID:', mentors[0].id);",
              "    console.log('  Price:', mentors[0].hourlyRate, 'EGP');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [{"key": "Authorization", "value": "Bearer {{token}}"}],
        "url": {
          "raw": "{{baseUrl}}/mentors",
          "host": ["{{baseUrl}}"],
          "path": ["mentors"]
        }
      }
    },
    {
      "name": "3. Get Mentor Available Slots",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Time slots retrieved', () => {",
              "    pm.response.to.have.status(200);",
              "    const data = pm.response.json().data;",
              "    const slots = data.availableSlots || data.slots || data;",
              "    if (Array.isArray(slots) && slots.length > 0) {",
              "        pm.environment.set('timeSlotId', slots[0].id);",
              "        console.log('✓ Available slot:', slots[0].startDateTime);",
              "        console.log('  Total slots:', slots.length);",
              "    } else {",
              "        console.log('No slots available');",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/mentors/{{mentorId}}/available-slots",
          "host": ["{{baseUrl}}"],
          "path": ["mentors", "{{mentorId}}", "available-slots"]
        }
      }
    },
    {
      "name": "4. Book Session",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Session booked', () => {",
              "    pm.response.to.have.status(201);",
              "    const data = pm.response.json().data;",
              "    const sessionId = data.id || data.sessionId;",
              "    pm.environment.set('sessionId', sessionId);",
              "    console.log('✓ Session booked:', sessionId);",
              "    console.log('  Status:', data.status);",
              "    console.log('  Price:', data.price || data.amount);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "Content-Type", "value": "application/json"},
          {"key": "Authorization", "value": "Bearer {{token}}"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"mentorId\": \"{{mentorId}}\",\n    \"timeSlotId\": \"{{timeSlotId}}\",\n    \"topic\": \"Payment Flow Test Session\",\n    \"duration\": 1\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/sessions",
          "host": ["{{baseUrl}}"],
          "path": ["sessions"]
        }
      }
    },
    {
      "name": "5. Create Payment Intent (Stripe)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Payment intent created', () => {",
              "    pm.response.to.have.status(201);",
              "    const data = pm.response.json().data;",
              "    pm.environment.set('paymentIntentId', data.paymentIntentId);",
              "    pm.environment.set('clientSecret', data.clientSecret);",
              "    console.log('✓ Payment Intent created');",
              "    console.log('  ID:', data.paymentIntentId);",
              "    console.log('  Amount:', data.amount, data.currency);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "Content-Type", "value": "application/json"},
          {"key": "Authorization", "value": "Bearer {{token}}"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"sessionId\": \"{{sessionId}}\",\n    \"paymentProvider\": 1\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/payments/create-intent",
          "host": ["{{baseUrl}}"],
          "path": ["payments", "create-intent"]
        }
      }
    },
    {
      "name": "6. Confirm Card Payment (Stripe API)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Payment confirmed with Stripe', () => {",
              "    pm.expect(pm.response.code).to.be.oneOf([200, 402]);",
              "    if (pm.response.code === 200) {",
              "        const data = pm.response.json();",
              "        console.log('✓ Payment Status:', data.status);",
              "        pm.environment.set('stripePaymentStatus', data.status);",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "auth": {
          "type": "basic",
          "basic": [{"key": "username", "value": "{{stripeSecretKey}}", "type": "string"}]
        },
        "method": "POST",
        "header": [{"key": "Content-Type", "value": "application/x-www-form-urlencoded"}],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {"key": "payment_method", "value": "pm_card_visa", "type": "text"},
            {"key": "return_url", "value": "https://example.com/payment-complete", "type": "text"}
          ]
        },
        "url": {
          "raw": "https://api.stripe.com/v1/payment_intents/{{paymentIntentId}}/confirm",
          "protocol": "https",
          "host": ["api", "stripe", "com"],
          "path": ["v1", "payment_intents", "{{paymentIntentId}}", "confirm"]
        }
      }
    },
    {
      "name": "7. Confirm Payment",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Payment confirmed', () => {",
              "    pm.response.to.have.status(200);",
              "    const data = pm.response.json().data;",
              "    console.log('✓ Payment Status:', data.status);",
              "    console.log('  Transaction ID:', data.providerTransactionId);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "Content-Type", "value": "application/json"},
          {"key": "Authorization", "value": "Bearer {{token}}"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"paymentIntentId\": \"{{paymentIntentId}}\",\n    \"sessionId\": \"{{sessionId}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/payments/confirm",
          "host": ["{{baseUrl}}"],
          "path": ["payments", "confirm"]
        }
      }
    },
    {
      "name": "8. Verify Session Confirmed",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Session retrieved', () => {",
              "    pm.response.to.have.status(200);",
              "    const data = pm.response.json().data;",
              "    console.log('✓ Session Status:', data.status);",
              "    console.log('  Scheduled:', data.scheduledStartTime);",
              "    console.log('  Meeting Link:', data.videoConferenceLink || 'Pending');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [{"key": "Authorization", "value": "Bearer {{token}}"}],
        "url": {
          "raw": "{{baseUrl}}/sessions/{{sessionId}}",
          "host": ["{{baseUrl}}"],
          "path": ["sessions", "{{sessionId}}"]
        }
      }
    },
    {
      "name": "9. Get Payment Details",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Payment details retrieved', () => {",
              "    pm.response.to.have.status(200);",
              "    const data = pm.response.json().data;",
              "    console.log('✓ Payment Details:');",
              "    console.log('  Amount:', data.amount, data.currency);",
              "    console.log('  Status:', data.status);",
              "    console.log('  Paid At:', data.paidAt);",
              "    console.log('  Release Date:', data.paymentReleaseDate);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [{"key": "Authorization", "value": "Bearer {{token}}"}],
        "url": {
          "raw": "{{baseUrl}}/payments/history",
          "host": ["{{baseUrl}}"],
          "path": ["payments", "history"]
        }
      }
    },
    {
      "name": "10. Join Session (Get Zoom Link)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Zoom link retrieved', () => {",
              "    const status = pm.response.code;",
              "    if (status === 200) {",
              "        const data = pm.response.json().data;",
              "        console.log('✓ Zoom Meeting Ready:');",
              "        console.log('  Join URL:', data.joinUrl);",
              "        console.log('  Meeting ID:', data.meetingId);",
              "    } else if (status === 409) {",
              "        console.log('⏳ Session not started yet');",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [{"key": "Authorization", "value": "Bearer {{token}}"}],
        "url": {
          "raw": "{{baseUrl}}/sessions/{{sessionId}}/join",
          "host": ["{{baseUrl}}"],
          "path": ["sessions", "{{sessionId}}", "join"]
        }
      }
    }
  ]
}
