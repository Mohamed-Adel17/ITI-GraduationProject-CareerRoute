<div class="payout-container max-w-6xl mx-auto px-4 py-6 space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm text-gray-500">Mentor Portal</p>
      <h1 class="text-2xl font-semibold">Earnings & Payouts</h1>
    </div>
    <button
      class="btn btn-primary"
      type="button"
      (click)="loadAll()"
      [disabled]="balanceLoading || historyLoading"
    >
      Refresh
    </button>
  </div>

  <!-- Balance cards with loading skeleton -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Available Balance -->
    <div class="card">
      <div class="flex items-center gap-1">
        <p class="label">Available for Withdrawal</p>
        <span class="tooltip" data-tooltip="Amount ready to withdraw now">
          <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </span>
      </div>
      <div *ngIf="balanceLoading" class="h-8 bg-gray-200 rounded animate-pulse mt-1"></div>
      <p *ngIf="!balanceLoading" class="value text-emerald-600">{{ formatAmount(availableBalance) }}</p>
      <p class="text-xs text-gray-500">Ready to request payout</p>
    </div>

    <!-- Pending Balance -->
    <div class="card">
      <div class="flex items-center gap-1">
        <p class="label">Pending (3-day hold)</p>
        <span class="tooltip" data-tooltip="Earnings held for 3 days after session completion for dispute protection">
          <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </span>
      </div>
      <div *ngIf="balanceLoading" class="h-8 bg-gray-200 rounded animate-pulse mt-1"></div>
      <p *ngIf="!balanceLoading" class="value text-amber-600">{{ formatAmount(pendingBalance) }}</p>
      <p class="text-xs text-gray-500">From recent sessions</p>
    </div>

    <!-- Lifetime Earnings -->
    <div class="card">
      <div class="flex items-center gap-1">
        <p class="label">Lifetime Earnings</p>
        <span class="tooltip" data-tooltip="Total amount earned from all completed sessions (after 15% platform fee)">
          <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </span>
      </div>
      <div *ngIf="balanceLoading" class="h-8 bg-gray-200 rounded animate-pulse mt-1"></div>
      <p *ngIf="!balanceLoading" class="value text-blue-600">{{ formatAmount(totalEarnings) }}</p>
      <p class="text-xs text-gray-500" *ngIf="balance?.lastUpdated">Updated {{ balance?.lastUpdated | date:'medium' }}</p>
    </div>
  </div>

  <!-- Payout request -->
  <div class="card p-4 space-y-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold">Request Payout</h2>
        <p class="text-sm text-gray-500">Minimum payout: 250 EGP. Maximum: your available balance.</p>
      </div>
      <span class="text-sm text-gray-600">Available: {{ formatAmount(availableBalance) }}</span>
    </div>

    <div class="flex flex-col gap-2">
      <div class="flex flex-col md:flex-row gap-3 items-center">
        <div class="flex flex-1 gap-2 w-full">
          <input
            type="number"
            min="250"
            step="0.01"
            class="input flex-1"
            placeholder="Amount (min 250 EGP)"
            [(ngModel)]="payoutAmount"
            (input)="payoutError = ''"
          />
          <button
            type="button"
            class="btn btn-secondary whitespace-nowrap"
            (click)="requestMax()"
            title="Fill maximum available amount"
          >
            Max
          </button>
        </div>
        <button
          class="btn btn-primary w-full md:w-auto"
          type="button"
          (click)="confirmPayout()"
          [disabled]="requestingPayout || availableBalance <= 0"
        >
          {{ requestingPayout ? 'Submitting...' : 'Submit Payout Request' }}
        </button>
      </div>
      <p *ngIf="payoutError" class="text-sm text-red-600">{{ payoutError }}</p>
    </div>
  </div>

  <!-- Confirmation Dialog -->
  <div *ngIf="showConfirmDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
      <h3 class="text-lg font-semibold mb-2">Confirm Payout Request</h3>
      <p class="text-gray-600 mb-4">
        You are about to request a payout of <strong>{{ formatAmount(+payoutAmount) }}</strong>.
        This will be processed by our team within 1-3 business days.
      </p>
      <div class="flex gap-3 justify-end">
        <button type="button" class="btn btn-secondary" (click)="showConfirmDialog = false">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="submitPayoutRequest()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="card p-4">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
      <div>
        <h2 class="text-lg font-semibold">Payout History</h2>
        <p class="text-sm text-gray-500">Latest payout requests and their status.</p>
      </div>
      <div class="flex items-center gap-3">
        <select
          class="input text-sm py-1.5"
          [(ngModel)]="statusFilter"
          aria-label="Filter by status"
        >
          <option value="">All Payouts</option>
          <option [value]="PayoutStatus.Pending">Pending</option>
          <option [value]="PayoutStatus.Processing">Processing</option>
          <option [value]="PayoutStatus.Completed">Completed</option>
          <option [value]="PayoutStatus.Failed">Failed</option>
          <option [value]="PayoutStatus.Cancelled">Cancelled</option>
        </select>
      </div>
    </div>

    <!-- Loading skeleton for history -->
    <div *ngIf="historyLoading" class="space-y-3">
      <div class="h-10 bg-gray-200 rounded animate-pulse"></div>
      <div class="h-10 bg-gray-100 rounded animate-pulse"></div>
      <div class="h-10 bg-gray-200 rounded animate-pulse"></div>
    </div>

    <!-- Empty state -->
    <div *ngIf="!historyLoading && filteredPayouts.length === 0" class="text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">
        {{ statusFilter ? 'No ' + statusFilter.toLowerCase() + ' payouts' : 'No payout requests' }}
      </h3>
      <p class="mt-1 text-sm text-gray-500">
        {{ statusFilter ? 'Try selecting a different status filter.' : 'Once you request a payout, it will appear here.' }}
      </p>
    </div>

    <!-- Mobile cards view -->
    <div class="sm:hidden space-y-3" *ngIf="!historyLoading && filteredPayouts.length > 0">
      <div *ngFor="let payout of filteredPayouts; trackBy: trackByPayout" class="border rounded-lg p-3 space-y-2">
        <div class="flex justify-between items-center">
          <span class="font-semibold text-lg">{{ formatAmount(payout.amount) }}</span>
          <span class="badge" [ngClass]="'badge-' + statusColor(payout.status)">
            {{ statusText(payout.status) }}
          </span>
        </div>
        <div class="text-sm text-gray-500">
          Requested: {{ payout.requestedAt | date:'mediumDate' }}
        </div>
        <div *ngIf="payout.completedAt" class="text-sm text-gray-500">
          Completed: {{ payout.completedAt | date:'mediumDate' }}
        </div>
      </div>
    </div>

    <!-- Desktop table view -->
    <div class="hidden sm:block overflow-x-auto" *ngIf="!historyLoading && filteredPayouts.length > 0">
      <table class="table">
        <thead>
          <tr>
            <th>Amount</th>
            <th>Status</th>
            <th>Requested</th>
            <th>Processed</th>
            <th>Completed</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let payout of filteredPayouts; trackBy: trackByPayout">
            <td class="font-semibold">{{ formatAmount(payout.amount) }}</td>
            <td>
              <span class="badge" [ngClass]="'badge-' + statusColor(payout.status)">
                {{ statusText(payout.status) }}
              </span>
            </td>
            <td>{{ payout.requestedAt | date:'mediumDate' }}</td>
            <td>{{ payout.processedAt ? (payout.processedAt | date:'mediumDate') : '—' }}</td>
            <td>{{ payout.completedAt ? (payout.completedAt | date:'mediumDate') : '—' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="flex items-center justify-between mt-4" *ngIf="history?.pagination as pg">
      <button class="btn btn-secondary text-sm" type="button" (click)="changePage(currentPage - 1)" [disabled]="currentPage <= 1">
        Previous
      </button>
      <div class="text-sm text-gray-600">
        Page {{ currentPage }} of {{ pg.totalPages }}
      </div>
      <button class="btn btn-secondary text-sm" type="button" (click)="changePage(currentPage + 1)" [disabled]="pg.hasNextPage === false">
        Next
      </button>
    </div>
  </div>
</div>
